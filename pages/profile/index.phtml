<?php
if (!isset($_GET["a"]))
    $_GET["a"] = $User["id"];
if (($user = fetch_user($_GET["a"]))->is_error())
    $user = $User;
else
    $user = $user->value;
$user = get_full_profile($user, []);
$edit_profile = try_get($_GET, "edit_profile", "0");
$allow_edit = is_admin() || $user == $User;

if (isset($_GET["modules"]) && (is_admin() || $user->id == $User["id"]))
{
    require_once (__DIR__."/report/request.php");
    return ;
}

/*
** Il faut faire un systeme de calcul d'"implication", basé sur les logs,
** la partition et les rendus, qui soit lissé dans le temps pour former une tendance
** Il faut faire un systeme de calcul de réussite, basé sur les médailles nouvellement
** acquises, le grade moyen et le nombre de flammes, pareil, lissé dans le temps
*/
?>
<table class="full_size_table">
    <tr><td>
	<table class="full_size_table"><tr><td style="width: 300px; vertical-align: top;">
	    <p style="text-align: center;">
		<b style="font-size: large;"><?php display_nickname($user, false); ?></b><br />
		<?php display_avatar($user); ?><br />
		<br />
		<b><?=$user->codename; ?></b><br />
		<?=ucfirst($user->first_name)." ".strtoupper($user->family_name); ?><br />
		<i><?=$user->nickname; ?></i><br />
		<br />
		<b><?=$Dictionnary["MemberSince"]; ?></b>:
		<?=human_date($user->registration_date, true); ?><br />
		<br />
		<?php
		$credits = 0;
		foreach ($user->sublayer as $cyc)
		{
		    foreach ($cyc->sublayer as $mod)
		    {
			$credits += $mod->get_credit();
		    }
		}
		?>
		<b><?=$credits." ".$Dictionnary["Credits"]; ?></b>
	    </p>
	</td><td style="overflow: auto;">
	    <?php
	    $panel = [
		$Dictionnary["PersonnalInformations"] => __DIR__."/data.phtml",
		$Dictionnary["Files"] => __DIR__."/files.phtml"
	    ];
	    tabpanel($panel, $Position.$user->id."datafiles", $Dictionnary["PersonnalInformations"]);
	    ?>
	</td></tr></table>
    </td><td rowspan="2">
	<?php
	$panel = ["#" => __DIR__."/personnal.phtml"];
	foreach ($user->merged_sublayers as $fdmy => $msl)
	    $panel[$fdmy] = __DIR__."/cycle.phtml";
	if ($user->assistant || $user->teacher || $user->director)
	    $panel[$Dictionnary["ManagedActivities"]] = __DIR__."/managed_activities.phtml";
	$panel[$Dictionnary["Intercom"]] = __DIR__."/intercom.phtml";
	tabpanel($panel, $Position.$user->id."cursus", "#");
	?>
    </td></tr><tr>
	<?php
	$_GET["w"] = 960;
	$_GET["h"] = 400;
	$_GET["e"] = now() + 60 * 60 * 12;
	$_GET["s"] = now() - 14 * 24 * 60 * 60;
	?>
	<td class="stats" style="height: 50%">
	    <?php
	    $panel = [
		$Dictionnary["ActivityLogs"] => __DIR__."/activity_logs.phtml",
		$Dictionnary["Presence"] => __DIR__."/presence.phtml",
		$Dictionnary["Medals"] => __DIR__."/medals.phtml",
		$Dictionnary["DeliveryDone"] => __DIR__."/delivery.phtml",
		$Dictionnary["AuthorizedFunctions"] => __DIR__."/authorized_functions.phtml",
		$Dictionnary["Laboratory"] => __DIR__."/laboratories.phtml",
	    ];
	    tabpanel($panel, $Position.$user->id."graphes", $Dictionnary["ActivityLogs"], "smallertext");
	    ?>
	</td>
    </tr>
</table>

