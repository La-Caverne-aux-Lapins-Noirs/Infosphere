<?php $nbline = 0; ?>
<table class="module_tab">
    <tr><td colspan="3" style="position: relative;">
	<h2><?=$matter->name ?: $matter->codename; ?></h2>
	<?php if ($matter->is_teacher) { ?>
	    <a href="<?=unrollurl(["b" => 1]); ?>" style="position: absolute; width: 40%; left: calc((100% - 40%) / 2); top: 10px; text-align: center; z-index: 1; color: black;">
		<?=$Dictionnary["ManageModule"]; ?> (<?=$matter->codename; ?>)
	    </a>
	    <?php
	    $link = [
		"p" => "InstancesMenu",
		"a" => $matter->id
	    ];
	    ?>
	    <a href="<?=unrollurl($link); ?>" style="position: absolute; right: 40px; top: 10px; z-index: 1; color: black;">
		<?=$Dictionnary["SeeInstanceConfiguration"]; ?>
	    </a>
	<?php } ?>
	<hr style="border-color: lightgray;" />
    </td></tr>
    <tr><td style="padding-top: 0px;">
    <?php if ($matter->emergence_date != NULL) { ?>
	<b><?=$Dictionnary["EmergenceDate"]; ?></b>:
	<?=litteral_date($matter->emergence_date); ?>
	<?php $nbline += 1; ?>
	<br />
    <?php } ?>
    <?php if ($matter->registration_date != NULL) { ?>
	<b><?=$Dictionnary["RegistrationOpenDate"]; ?></b>:
	<?=litteral_date($matter->registration_date); ?>
	<?php $nbline += 1; ?>
	<br />
    <?php } ?>
    <?php if ($matter->close_date != NULL) { ?>
	<b><?=$Dictionnary["RegistrationCloseDate"]; ?></b>:
	<?=litteral_date($matter->close_date); ?>
	<?php $nbline += 1; ?>
	<br />
    <?php } ?>
    <?php if ($matter->done_date != NULL) { ?>
	<b><?=$Dictionnary["DoneDate"]; ?></b>:
	<?=litteral_date($matter->done_date); ?>
	<?php $nbline += 1; ?>
	<br />
    <?php } ?>
    
    <?php if ($matter->maximum_subscription != -1) { ?>
	<?php $nbline += 1; ?>
	<?=$Dictionnary["MaximumSubscription"].": ".$matter->maximum_subscription; ?>
    <?php } ?>
</td><td style="padding: 0;">
    <?php require ("grade_array.phtml"); ?>
</td><td style="padding-top: 0px; text-align: center;">

    <?php $js = "silent_submit(this); setTimeout(function() { location.reload(); }, 500);"; ?>
    
    <?php if ($matter->subscription == FullActivity::AUTOMATIC_SUBSCRIPTION) { ?>
	<b><?=$Dictionnary["SubscriptionIsAutomatic"]; ?></b>

    <?php } else if ($matter->registered) { ?>
	<b><?=$Dictionnary["Subscribed"]; ?></b><br />
	<?php if ($matter->allow_unregistration) { ?>
	    <form method="put" action="/api/module/<?=$matter->id; ?>/registration">
		<input
		    type="button"
		    class="modulebutton"
		    onclick="<?=$js; ?>"
		    value="<?=$Dictionnary["Unsubscribe"]; ?>"
		    style="width: 100%; height: 70px; font-size: large; border: 0;"
		/>
	    </form>
	<?php } else { ?>
	    <?=$Dictionnary["UnsubscribeIsNotPossible"]; ?>
	<?php } ?>
	
    <?php } else if (!period($matter->registration_date, $matter->close_date)) { ?>
	<b><?=$Dictionnary["SubscriptionPeriodIsClose"]; ?></b>
	
    <?php } else { ?>
	<form method="put" action="/api/module/<?=$matter->id; ?>/registration">
	    <input
		type="button"
		class="modulebutton"
		value="<?=$Dictionnary["Subscribe"]; ?>"
		style="width: 100%; height: 70px; font-size: large; border: 0; cursor: pointer;"
	    />
	</form>
	<b style="color: red;"><?=$Dictionnary["UnsubscribeIsForbidden"]; ?>.</b>
    <?php } ?>

</td></tr><tr><td colspan="3" style="text-indent: 40px";>
    <?=$matter->description; ?>
</td></tr><tr><td colspan="3" class="medalscroll" style="min-height: 50px;">
    <div style="text-align: center; min-height: 50px;">
	<?php if (!count($matter->medal)) { ?>
	    <span style="position: relative; top: 10px; left: 10px; font-style: italic; color: gray;">
		<?=$Dictionnary["NoAssociatedMedalToMatter"]; ?>
	    </span>
	<?php } ?>
	<?php $matter->medal = sort_by_medal_grade($matter->medal, false); ?>
	<?php foreach ($matter->medal as $medal) { ?>
	    <?php if ($medal["role"] == 0) continue ; ?>
	    <div
		class="medal_box_picture"
		style="
		       position: relative;
		       display: inline-block; margin-left: 5px; margin-right: 5px;
		       background-image: url('<?=$medal["icon"]; ?>');
		       <?php if ($medal["band"] != NULL) { ?>
		       border-radius: 50px;
		       width: 92px !important; height: 92px !important;
		       <?php } ?>
		       "
	    >
		<?php if ((!isset($medal["module_medal"]) || $medal["module_medal"])) { ?>
		    <img
			src="res/grade_<?=["d", "c", "b", "a"][$medal["role"] - 1]; ?>.png"
			style="position: absolute; top: 0px; right: -10px; width: 40px; height: 40px;"
		    />
		<?php } ?>
		<?php if (@$medal["local"]) { ?>
		    <img
			src="res/local.png"
			style="position: absolute; bottom: 0px; right: -10px; width: 40px; height: 40px;"
		    />
		<?php } ?>
	    </div>
	<?php } ?>
    </div>
    <?php if (isset($matter->validation_by_percent)) { ?>
</td></tr><tr><td colspan="3">
    <?php require (__DIR__."/../profile/progress.php"); ?>
    <?php } ?>
</td></tr></table>

<?php foreach ($matter->sublayer as $act) { ?>
    <?php $act = $act->full_activity; ?>
    <?php require ("activity.php"); ?>
<?php } ?>
